@using armaoffline.Models
@using Microsoft.Maui.Controls
@inject armaoffline.Repositories.IArmaApi _armaApi
@inject armaoffline.Services.GlobalState _globalState
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject Services.IMediaElementService _audioPlayer
@page "/offlineplayer"
@{
    
}

<h1>Armaradio</h1>

<div class="row">
    <div class="col-md-12">
        <h3 id="lblTblHeaderPlaylistName"></h3>
    </div>
</div>
<div class="row mt-3">
    <div class="col-md-12">
        <table id="tblMainPlayList">
            <tbody></tbody>
        </table>
    </div>
</div>
<div class="bottom-gap"></div>

<!-- Player Controls -->
<div class="player-float-bottom">
    <div class="block-item">
        <div>
            <button @onclick="PlayPause" class="player-btn player-@(IsPlaying ? "pause" : "play")">
                <div class="player-inner"></div>
            </button>
            <input type="range" id="sldPlayerLocation" min="0" max="100" value="0" class="ms-3 me-3">
            <button @onclick="NextSong" class="player-btn player-next">
                <div class="player-inner"></div>
            </button>
        </div>
        <div class="align-center">
            <label>@ElapsedTime / @TotalTime</label>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int? PlaylistId { get; set; }
    public string PlaylistTitle { get; set; }

    private static armaoffline.Repositories.IArmaApi _armaStaticApi =
        armaoffline.Providers.ServiceLocator.ServiceProvider.GetRequiredService<armaoffline.Repositories.IArmaApi>();
    private static Action<string, string, string> _playAction;
    private static Action<double?> _playerPositionAction;

    private System.Timers.Timer _elapsedTimer;
    private System.Timers.Timer _heartbeatTimer;
    public bool IsPlaying { get; private set; } = false;
    public string ElapsedTime { get; private set; } = "00:00";
    public string TotalTime { get; private set; } = "00:00";

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        PlaylistId = (int.TryParse(query["playlistid"], out int _playlistId) ? _playlistId : null);
        PlaylistTitle = query["playlisttitle"] ?? "";

        _elapsedTimer = new System.Timers.Timer(1000);
        _elapsedTimer.Elapsed += UpdateElapsedTime;

        _audioPlayer.MediaEndedEvent += OnPlaybackEnded;

        _playAction = PlaySong;
        _playerPositionAction = PlayerAudioPosition;

        NavigationManager.LocationChanged += HandleLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            List<ArmaPlaylistDataItem> firstPlaylist = new List<ArmaPlaylistDataItem>();

            if (PlaylistId.HasValue)
            {
                firstPlaylist = _armaApi.Offline_GetPlaylistById(PlaylistId.Value);
            }

            await JS.InvokeVoidAsync("onOfflinePlayerOnload");
            await JS.InvokeVoidAsync("populateSongsToPlayerTable", firstPlaylist, PlaylistTitle);
        }
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        // Clean up audio resources before navigating
        CleanupAudioResources();
    }

    private async void CleanupAudioResources()
    {
        _audioPlayer.MediaEndedEvent -= OnPlaybackEnded;
        await _audioPlayer.Stop();

        _elapsedTimer?.Stop();
        _elapsedTimer?.Dispose();
    }

    private async void PlaySong(string songId, string artistName, string songName)
    {
        if (!string.IsNullOrWhiteSpace(songId))
        {
            string songWithPath = _armaApi.GetFileWithPath($"{songId}.m4a");

            await InvokeAsync(async () =>
            //MainThread.BeginInvokeOnMainThread(() =>
            {
                await _audioPlayer.SetMediaSource(songWithPath);
                await _audioPlayer.SetMetaData(artistName, songName);
                await _audioPlayer.Play();

                _elapsedTimer.Start();
                IsPlaying = true;

                StateHasChanged();
            });
        }
        else
        {
            await InvokeAsync(async () =>
            {
                _audioPlayer.MediaEndedEvent -= OnPlaybackEnded;
                await _audioPlayer.Stop();
                _elapsedTimer.Stop();
                IsPlaying = false;
                _audioPlayer.MediaEndedEvent += OnPlaybackEnded;

                ElapsedTime = "00:00";
                TotalTime = "00:00";

                await JS.InvokeVoidAsync("updatePlayerSliderPosition", 0);

                StateHasChanged();
            });
        }
    }

    [JSInvokable]
    public static void Play(string songId, string artistName, string songName)
    {
        _playAction?.Invoke(songId, artistName, songName);
    }

    [JSInvokable]
    public static void SetAudioToPosition(double? position)
    {
        _playerPositionAction?.Invoke(position);
    }

    private async void PlayerAudioPosition(double? position)
    {
        if (position.HasValue)
        {
            await InvokeAsync(async () =>
            {
                if (position > 0)
                {
                    TimeSpan songDuration = await _audioPlayer.GetDuration();

                    double newSeconds = ((position.Value / 100) * songDuration.TotalSeconds);
                    TimeSpan duration = TimeSpan.FromSeconds(newSeconds);

                    await _audioPlayer.Seek(duration);

                    StateHasChanged();
                }
            });
        }
    }

    private async void PlayPause()
    {
        if (!_audioPlayer.IsMediaLoaded()) return;

        await InvokeAsync(async () =>
        {
            if (IsPlaying)
            {
                await _audioPlayer.Pause();
                _elapsedTimer.Stop();
                IsPlaying = false;
            }
            else
            {
                await _audioPlayer.Play();
                _elapsedTimer.Start();
                IsPlaying = true;
            }

            StateHasChanged();
        });
    }

    private async Task NextSong()
    {
        await InvokeAsync(async () =>
        {
            _audioPlayer.MediaEndedEvent -= OnPlaybackEnded;
            await _audioPlayer.Stop();
            _elapsedTimer.Stop();
            _audioPlayer.MediaEndedEvent += OnPlaybackEnded;

            StateHasChanged();
        });

        await JS.InvokeVoidAsync("playNextAvailableSong");
    }

    private string FormatTime(TimeSpan seconds)
    {
        return seconds.ToString(@"mm\:ss");
    }

    private async void UpdateElapsedTime(object sender, System.Timers.ElapsedEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            TimeSpan currentPosition = await _audioPlayer.GetCurrentPosition();
            TimeSpan currentDuration = await _audioPlayer.GetDuration();

            ElapsedTime = FormatTime(currentPosition);
            TotalTime = FormatTime(currentDuration);

            double sliderPosition = 0;

            if (currentPosition.TotalSeconds > 0 && currentDuration.TotalSeconds > 0)
            {
                sliderPosition = (currentPosition.TotalSeconds / currentDuration.TotalSeconds) * 100;
            }

            await JS.InvokeVoidAsync("updatePlayerSliderPosition", sliderPosition);

            StateHasChanged();
        });
    }

    private async void OnPlaybackEnded(object sender, EventArgs e)
    {
        // Ensure this runs on the UI thread
        await InvokeAsync(async () =>
        {
            // Automatically move to the next song
            await NextSong();
        });
    }


    public void Dispose()
    {
        // Remove event handler to prevent memory leaks
        NavigationManager.LocationChanged -= HandleLocationChanged;

        CleanupAudioResources();
    }
}